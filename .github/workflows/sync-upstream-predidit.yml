name: Sync predidit into this repo

on:
  schedule:
    - cron: '0 3 * * *' # daily at 03:00 UTC
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure predidit remote
        run: |
          git remote add predidit https://github.com/Predidit/media-kit.git || true
          git fetch predidit

      - name: Create sync branch
        id: branch
        run: |
          BRANCH=sync/predidit-$(date +"%Y%m%d%H%M%S")
          echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH"

      - name: Attempt merge predidit/main
        id: merge_predidit
        run: |
          set -euo pipefail
          if git merge --no-commit --no-ff predidit/main; then
            git commit -m "Merge predidit/main"
            echo "pred_merged=true" >> $GITHUB_OUTPUT
          else
            echo "pred_merged=false" >> $GITHUB_OUTPUT
            echo "conflict=predidit" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Push branch (if merged)
        if: steps.merge_predidit.outputs.pred_merged == 'true'
        run: |
          git push origin HEAD:$BRANCH

      - name: Create PR (merged case)
        if: steps.merge_predidit.outputs.pred_merged == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Automated: merge predidit/main into main"
          title: "chore(sync): merge predidit into main"
          body: |
            This PR was created automatically by a workflow that merges `Predidit/media-kit` into this repository.

            - If CI passes, maintainers can merge this PR.
          base: main

      - name: Create issue for conflicts
        if: steps.merge_predidit.outputs.pred_merged == 'false'
        run: |
          echo "Conflict detected while attempting to merge predidit. Creating an issue."
          TITLE="Auto-sync conflict: $(date +"%Y-%m-%d %H:%M:%S")"
          BODY="Automatic sync attempted but merge conflict occurred when merging \`predidit/main\` into this repository. Please merge manually or resolve conflicts.\n\nRemote fetched: predidit=https://github.com/Predidit/media-kit.git"
          gh issue create --title "$TITLE" --body "$BODY" || echo "gh not available, skipping issue creation"
